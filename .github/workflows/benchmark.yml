name: Benchmark

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  schedule:
    # Run weekly on Sunday at 4 AM UTC
    - cron: '0 4 * * 0'

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for comparison
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true
        cache-dependency-path: go.sum
    
    - name: Download dependencies
      run: go mod download
    
    - name: Run benchmarks (current)
      run: |
        go test -bench=. -benchmem -benchtime=10s ./test/benchmark/... | tee benchmark-current.txt
    
    - name: Checkout base branch
      if: github.event_name == 'pull_request'
      run: |
        git fetch origin ${{ github.base_ref }}
        git checkout origin/${{ github.base_ref }}
    
    - name: Run benchmarks (base)
      if: github.event_name == 'pull_request'
      run: |
        go test -bench=. -benchmem -benchtime=10s ./test/benchmark/... | tee benchmark-base.txt || true
    
    - name: Install benchstat
      run: go install golang.org/x/perf/cmd/benchstat@latest
    
    - name: Compare benchmarks
      if: github.event_name == 'pull_request'
      id: compare
      run: |
        if [ -f benchmark-base.txt ]; then
          echo "## Benchmark Results" > benchmark-comment.txt
          echo "" >> benchmark-comment.txt
          benchstat benchmark-base.txt benchmark-current.txt >> benchmark-comment.txt || true
        else
          echo "Base benchmark not available" > benchmark-comment.txt
        fi
    
    - name: Comment PR with benchmark results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('benchmark-comment.txt', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## âš¡ Benchmark Results\n\n' + comment
          });
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v6
      with:
        name: benchmark-results
        path: |
          benchmark-*.txt
        retention-days: 30
    
    - name: Check for performance regression
      if: github.event_name == 'pull_request'
      run: |
        # Parse benchstat output for significant regressions
        # Fail if any metric regressed by >20%
        if grep -q "+[2-9][0-9]\.[0-9][0-9]%" benchmark-comment.txt; then
          echo "::warning::Performance regression detected (>20%)"
          echo "Review benchmark results before merging"
        fi
