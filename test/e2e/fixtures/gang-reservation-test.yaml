# Gang Scheduling with Resource Reservation Test
#
# This test demonstrates:
# 1. Gang scheduling (Coscheduling plugin) - all 3 pods wait until all are ready
# 2. Resource reservation (ResourceReservation plugin) - prevents resource starvation
#
# RBAC Note: Ensure the scheduler ClusterRole has permissions for resourcereservations:
#   kubectl patch clusterrole kubenexus-scheduler --type='json' -p='[
#     {
#       "op": "add",
#       "path": "/rules/-",
#       "value": {
#         "apiGroups": ["scheduling.kubenexus.io"],
#         "resources": ["resourcereservations"],
#         "verbs": ["get", "list", "watch", "create", "update", "patch", "delete"]
#       }
#     }
#   ]'

---
apiVersion: v1
kind: Namespace
metadata:
  name: reservation-test
---
# Gang Pod 1
apiVersion: v1
kind: Pod
metadata:
  name: reserved-gang-1
  namespace: reservation-test
  labels:
    pod-group.scheduling.kubenexus.io/name: reserved-gang
    pod-group.scheduling.kubenexus.io/min-available: "3"
spec:
  schedulerName: kubenexus-scheduler
  containers:
  - name: worker
    image: busybox:1.36
    command: ["sleep", "3600"]
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 256Mi
---
# Gang Pod 2
apiVersion: v1
kind: Pod
metadata:
  name: reserved-gang-2
  namespace: reservation-test
  labels:
    pod-group.scheduling.kubenexus.io/name: reserved-gang
    pod-group.scheduling.kubenexus.io/min-available: "3"
spec:
  schedulerName: kubenexus-scheduler
  containers:
  - name: worker
    image: busybox:1.36
    command: ["sleep", "3600"]
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 256Mi
---
# Gang Pod 3
apiVersion: v1
kind: Pod
metadata:
  name: reserved-gang-3
  namespace: reservation-test
  labels:
    pod-group.scheduling.kubenexus.io/name: reserved-gang
    pod-group.scheduling.kubenexus.io/min-available: "3"
spec:
  schedulerName: kubenexus-scheduler
  containers:
  - name: worker
    image: busybox:1.36
    command: ["sleep", "3600"]
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 256Mi
