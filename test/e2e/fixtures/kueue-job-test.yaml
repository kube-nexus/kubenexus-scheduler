---
# Complete Kueue + Job-based Workload API Test
# This shows how Kueue manages Jobs with gang scheduling

# Test Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: workload-test
---
# ResourceFlavor - defines available resources
apiVersion: kueue.x-k8s.io/v1beta1
kind: ResourceFlavor
metadata:
  name: default-flavor
---
# ClusterQueue - cluster-wide queue with resource limits
apiVersion: kueue.x-k8s.io/v1beta1
kind: ClusterQueue
metadata:
  name: cluster-queue
spec:
  namespaceSelector: {}
  resourceGroups:
  - coveredResources: ["cpu", "memory"]
    flavors:
    - name: default-flavor
      resources:
      - name: "cpu"
        nominalQuota: 10
      - name: "memory"
        nominalQuota: 10Gi
---
# LocalQueue - namespace-scoped queue
apiVersion: kueue.x-k8s.io/v1beta1
kind: LocalQueue
metadata:
  name: local-queue
  namespace: workload-test
spec:
  clusterQueue: cluster-queue
---
# Job with gang scheduling via Kueue
apiVersion: batch/v1
kind: Job
metadata:
  name: gang-job
  namespace: workload-test
  labels:
    kueue.x-k8s.io/queue-name: local-queue
spec:
  parallelism: 3
  completions: 3
  template:
    spec:
      schedulerName: kubenexus-scheduler
      restartPolicy: Never
      containers:
      - name: worker
        image: busybox:latest
        command: ["sh", "-c", "echo Hello from pod $HOSTNAME && sleep 30"]
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
